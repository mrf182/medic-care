(function($, window, document, undefined) {
    $.fn.extend({
        scrollspy: function(options) {
            var defaults = {
                namespace: "scrollspy",
                activeClass: "active",
                animate: false,
                duration: 1000,
                offset: 0,
                container: window,
                replaceState: false
            };
            
            options = $.extend({}, defaults, options);


            var add = function(ex1, ex2) {
                return parseInt(ex1, 10) + parseInt(ex2, 10);
            };


            var findElements = function(links) {
                var elements = [];
                for (var i = 0; i < links.length; i++) {
                    var link = $(links[i]).attr("href");
                    // Escape the '/' character to avoid jQuery syntax errors
                    if (link) {
                        var escapedLink = link.replace(/\//g, "\\/");
                        if ($(escapedLink).length > 0) {
                            elements.push($(escapedLink));
                        }
                    }
                }
                return elements;
            };


            return this.each(function() {
                var self = this,
                    $self = $(self),
                    links = $self.find("a"),
                    targets = findElements(links);


                $(options.container).on("scroll." + options.namespace, function() {
                    var scrollPosition = $(this).scrollTop() + options.offset;


                    for (var i = 0; i < targets.length; i++) {
                        var $target = $(targets[i]);
                        if (scrollPosition >= $target.offset().top) {
                            links.removeClass(options.activeClass);
                            links.eq(i).addClass(options.activeClass);
                        }
                    }
                });


                if (options.replaceState && history.replaceState) {
                    links.on("click", function(e) {
                        var link = $(this).attr("href");
                        history.replaceState(null, null, link);
                    });
                }
            });
        }
    });
})(jQuery, window, document);
